---
layout: post
title:  2d mesh with Verlet integration
indexflag: false
excerpt:  none

suggested: vtvt-demo
tag: [art, visualisation, js]
---

### 2d mesh with Verlet integration in vanilla js


<style>
  #canvas{outline:solid;outline-width:1px;outline-color:DarkGrey}@media screen and (max-width:42em){#canvas{width:90vmin;height:90vmin}}@media screen and (min-width:42em) and (max-width:64em){#canvas{width:75vmin;height:75vmin}}@media screen and (min-width:64em){#canvas{width:65vmin;height:65vmin}}}
</style>

<canvas id="canvas"></canvas>

<script>
function print(){}class Point{constructor(s,t,i=!1){this.curPosX=s,this.curPosY=t,this.prevPosX=this.curPosX,this.prevPosY=this.curPosY,this.pinned=i}updatePos(){if(!this.pinned){let s=this.curPosX,t=this.curPosY;this.curPosX+=dampCoef*(this.curPosX-this.prevPosX),this.curPosY+=dampCoef*(this.curPosY-this.prevPosY),this.curPosY+=gravity*step*step,this.prevPosX=s,this.prevPosY=t}}}class Stick{constructor(s,t,i=.51){this.pointA=s,this.pointB=t,this.halfLen=i}correctPos(){let s=(this.pointA.curPosX+this.pointB.curPosX)/2,t=(this.pointA.curPosY+this.pointB.curPosY)/2,i=this.pointA.curPosX-this.pointB.curPosX,o=this.pointA.curPosY-this.pointB.curPosY,e=Math.sqrt(i**2+o**2);i=i/e*this.halfLen,o=o/e*this.halfLen,this.pointA.pinned||(this.pointA.curPosX=s+i,this.pointA.curPosY=t+o),this.pointB.pinned||(this.pointB.curPosX=s-i,this.pointB.curPosY=t-o)}}class Scene{constructor(s,t,i){this.canvas=document.getElementById(s),this.rows=t,this.cols=i,this.ctx=this.canvas.getContext("2d"),this.canvas.width=this.canvas.offsetWidth*devicePixelRatio,this.canvas.height=this.canvas.offsetHeight*devicePixelRatio,this.canvasPos=this.canvas.getBoundingClientRect(),this.selectedPointInd=void 0,this.selectionOffsetX=void 0,this.selectionOffsetY=void 0,this.points=[],this.sticks=[],this.clickDistSq=.5*(this.canvas.width/this.cols)**2,this._onMouseDown=this.onMouseDown.bind(this),this._deselectPoint=this.deselectPoint.bind(this),this._onMouseMove=this.onMouseMove.bind(this),this._onTouchStart=this.onTouchStart.bind(this),this._onTouchMove=this.onTouchMove.bind(this),this.canvas.addEventListener("mousedown",this._onMouseDown),this.canvas.addEventListener("touchstart",this._onTouchStart),window.requestAnimationFrame(this._render=this.render.bind(this))}simulate(){for(var s of this.points)s.updatePos();for(var t of this.sticks)t.correctPos()}render(){for(let s=0;s<3;s++)this.simulate();this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let s=0;s<this.rows;s+=2){this.ctx.beginPath(),this.ctx.moveTo(~~this.points[s*this.cols].curPosX,~~(this.canvas.height-this.points[s*this.cols].curPosY));for(let t=1;t<this.cols;t++)this.ctx.lineTo(~~this.points[s*this.cols+t].curPosX,~~(this.canvas.height-this.points[s*this.cols+t].curPosY)),this.ctx.moveTo(~~this.points[s*this.cols+t].curPosX,~~(this.canvas.height-this.points[s*this.cols+t].curPosY));this.ctx.stroke()}for(let s=0;s<this.cols;s+=2){this.ctx.beginPath(),this.ctx.moveTo(~~this.points[s].curPosX,~~(this.canvas.height-this.points[s].curPosY));for(let t=1;t<this.rows;t++)this.ctx.lineTo(~~this.points[t*this.cols+s].curPosX,~~(this.canvas.height-this.points[t*this.cols+s].curPosY)),this.ctx.moveTo(~~this.points[t*this.cols+s].curPosX,~~(this.canvas.height-this.points[t*this.cols+s].curPosY));this.ctx.stroke()}window.requestAnimationFrame(this._render)}onMouseDown(s){this.canvasPos=this.canvas.getBoundingClientRect(),this.x=2*(s.clientX-this.canvasPos.left),this.y=this.canvas.height-2*(s.clientY-this.canvasPos.top),this.selectPoint(this.x,this.y)}onTouchStart(s){s.preventDefault(),this.canvasPos=this.canvas.getBoundingClientRect(),this.x=2*(s.touches[0].clientX-this.canvasPos.left),this.y=this.canvas.height-2*(s.touches[0].clientY-this.canvasPos.top),this.selectPoint(this.x,this.y)}checkHit(s,t,i){return(s.curPosX-t)**2+(s.curPosY-i)**2<this.clickDistSq}selectPoint(s,t){for(var i in this.points)if(this.checkHit(this.points[i],s,t))return this.selectedPointInd=i,this.points[i].pinned=!0,this.selectionOffsetX=s-this.points[i].curPosX,this.selectionOffsetY=t-this.points[i].curPosY,this.canvas.removeEventListener("mousedown",this._onMouseDown),this.canvas.removeEventListener("touchstart",this._onTouchStart),this.canvas.addEventListener("mouseup",this._deselectPoint),this.canvas.addEventListener("touchend",this._deselectPoint),this.canvas.addEventListener("mousemove",this._onMouseMove),void this.canvas.addEventListener("touchmove",this._onTouchMove)}onMouseMove(s){let t=2*(s.clientX-this.canvasPos.left)-this.selectionOffsetX,i=this.canvas.height-2*(s.clientY-this.canvasPos.top)-this.selectionOffsetY;this.points[this.selectedPointInd].curPosX=~~t,this.points[this.selectedPointInd].curPosY=~~i}onTouchMove(s){s.preventDefault();let t=2*(s.touches[0].clientX-this.canvasPos.left)-this.selectionOffsetX,i=this.canvas.height-2*(s.touches[0].clientY-this.canvasPos.top)-this.selectionOffsetY;this.points[this.selectedPointInd].curPosX=~~t,this.points[this.selectedPointInd].curPosY=~~i}deselectPoint(s){void 0!==this.selectedPointInd&&(this.points[this.selectedPointInd].pinned=!1,this.selectedPointInd=void 0),this.canvas.removeEventListener("mousemove",this._onMouseMove),this.canvas.removeEventListener("touchmove",this._onTouchMove),this.canvas.removeEventListener("mouseup",this._deselectPoint),this.canvas.removeEventListener("touchend",this._deselectPoint),this.canvas.addEventListener("mousedown",this._onMouseDown),this.canvas.addEventListener("touchstart",this._onTouchStart)}}const rows=79,cols=105,step=.2,gravity=-.5,dampCoef=.999;scn=new Scene("canvas",79,105);for(let s=0;s<79;s++)for(let t=0;t<105;t++)scn.points.push(new Point(scn.canvas.width*(.1+t/105*.8),.95*scn.canvas.height-scn.canvas.width/105*.8*s));for(let s=0;s<105;s+=4)scn.points[s].pinned=!0;for(let s=0;s<79;s++)for(let t=0;t<104;t++)scn.sticks.push(new Stick(scn.points[105*s+t],scn.points[105*s+t+1],Math.sqrt((scn.points[105*s+t+1].curPosX-scn.points[105*s+t].curPosX)**2+(scn.points[105*s+t+1].curPosY-scn.points[105*s+t].curPosY)**2)/2));for(let s=0;s<8190;s++)scn.sticks.push(new Stick(scn.points[s],scn.points[s+105],Math.sqrt((scn.points[s+105].curPosX-scn.points[s].curPosX)**2+(scn.points[s+105].curPosY-scn.points[s].curPosY)**2)/2));
</script>
